<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>The Python Multiprocessing Queue and Large Objects - Bryce Boe</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    

    <!-- Open Graph tags -->
            <meta property="og:type" content="article"/>
            <meta property="og:title" content="The Python Multiprocessing Queue and Large Objects"/>
            <meta property="og:url" content="http://bryceboe.com/2011/01/28/the-python-multiprocessing-queue-and-large-objects/"/>
            <meta property="og:description" content="The Usenix security deadline is quickly approaching, and that means finalizing everything on my research project. Therefore, today I wanted to quickly parallelize some of my analysis code to take advantage of the eight virtual processors on my machine. I previously wrote about python multiprocessing and keyboard interrupts, so the ..."/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://bryceboe.com/theme/css/bootstrap.cerulean.min.css" type="text/css"/>
    <link href="http://bryceboe.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://bryceboe.com/theme/css/pygments/solarizedlight.css" rel="stylesheet">
        <link href="http://bryceboe.com/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="http://bryceboe.com/theme/css/style.css" type="text/css"/>

        <link href="http://bryceboe.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Bryce Boe ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://bryceboe.com/" class="navbar-brand">
Bryce Boe            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="http://bryceboe.com/pages/about">
                             About
                          </a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://bryceboe.com/archives/"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://bryceboe.com/2011/01/28/the-python-multiprocessing-queue-and-large-objects/"
                       rel="bookmark"
                       title="Permalink to The Python Multiprocessing Queue and Large Objects">
                        The Python Multiprocessing Queue and Large&nbsp;Objects
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2011-01-28T01:16:00-08:00"> Fri 28 January 2011</time>
    </span>



<span class="label label-default">Tags</span>
	<a href="http://bryceboe.com/tag/python/">python</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>The <a href="http://usenix.org/events/sec11/">Usenix security</a> deadline is quickly approaching, and that means
finalizing everything on my research project. Therefore, today I <em>wanted to</em>
quickly parallelize some of my analysis code to take advantage of the eight
virtual processors on my machine. I previously wrote about <a href="/2010/08/26/python-multiprocessing-and-keyboardinterrupt/">python
multiprocessing and keyboard interrupts</a>, so the task of converting my code
seemed pretty trivial. Unfortunately, my analysis code deals with large amounts
of data which when passed to processes using the <a href="http://docs.python.org/library/multiprocessing.html#multiprocessing.Queue">multiprocessing queue
class</a>, produced unexpected results. Thus the sample I originally used in my
previous post, isn&#8217;t as robust as I hoped. <del>It will soon be updated.<del>
<ins datetime="2011-01-28T19:08:44+00:00">The post has been updated with a
reference to this post.</ins></p>
<p>The issue is that when pushing large items onto the queue, the items are
essentially buffered, despite the immediate return of the queue&#8217;s <em>put</em>
function [endnote <a href="#ref1">1</a>]. Therefore, the queue may have not yet completely
added an item by the time a subsequent non-blocking call to the queue&#8217;s <em>get</em>
function is made. This delay explains why such a non-blocking call to
<strong>queue.get</strong> may return a <strong>Queue.Empty</strong> error and is the exact problem I
encountered in my analysis&nbsp;code.</p>
<p>As usual, I have provided some code demonstrating the problem and a&nbsp;solution.</p>
<div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span><span class="o">,</span> <span class="nn">Queue</span>

<span class="k">def</span> <span class="nf">worker_bad</span><span class="p">(</span><span class="n">jobs</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">break</span>

<span class="k">def</span> <span class="nf">worker_good</span><span class="p">(</span><span class="n">jobs</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">jobs</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tmp</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">break</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">num_workers</span><span class="p">,</span> <span class="n">good_test</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">good_test</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">worker_good</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">worker_bad</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
        <span class="n">jobs</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_workers</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">good_test</span><span class="p">:</span>
            <span class="n">jobs</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">jobs</span><span class="p">,))</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">workers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">:</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jobs</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">workers</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">workers</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">10000</span>

    <span class="k">for</span> <span class="n">good_test</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">]:</span>
        <span class="n">passed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
            <span class="n">passed</span> <span class="o">+=</span> <span class="n">main</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">workers</span><span class="p">,</span> <span class="n">good_test</span><span class="o">=</span><span class="n">good_test</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%d%%</span><span class="s"> passed (Good Test: </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">passed</span><span class="p">,</span> <span class="n">good_test</span><span class="p">)</span>
</pre></div>


<p>This code provides a simple test framework to compare two methods for
completing tasks in a job queue. The actual workers are virtually identical as
they simply continue to pull items off the job queue, until there are no more
jobs. An individual test is considered passed when the number of jobs remaining
after the workers terminate is zero. When running this script, you should
notice that the first group has fewer than 100% of the tests pass, and more
importantly that the second group has a 100% pass rate. If your output shows
the first with a 100% pass rate, try doubling or further increasing the value
of the variable <strong>size</strong> on line 39. Additionally you may notice I/O errors.
These errors likely represent a bug in the multiprocessing queue and further
demonstrate that a call to queue.get immediately after queue.put will not
always&nbsp;succeed.</p>
<p>I arrived at the solution to this problem, in the response to a slightly
similar stackoverflow question titled, <a href="http://stackoverflow.com/questions/1540822/dumping-a-multiprocessing-queue-into-a-list">Dumping a multiprocessing.Queue into a
list</a>. The solution recommended by the stackoverflow response is to enqueue a
sentinel after all data in order to clearly delineate the end of the queue
rather than utilizing the empty state of the queue. However, a single sentinel
will not work in a case where there are multiple worker processes as only one
worker can receive the sentinel. Thus the intuitive solution is to enqueue as
many sentinels as there are workers on the queue following the data. I chose to
represent these sentinels by the value <strong>None</strong> shown on line&nbsp;28.</p>
<p>Now I can get back to speeding up my data analysis. Happy&nbsp;coding!</p>
<p><a name="ref1"></a>Endnote 1: Observant readers might notice that the queue&#8217;s
put function has a <strong>block</strong> argument, however that argument, <strong>true</strong> by
default, is for cases when the queue has a maximum&nbsp;size.</p>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="http://bryceboe.com/2009/12/06/ictf09-–-ucsbs-international-capture-the-flag-competition/">iCTF09: <span class="caps">UCSB</span>&#8217;s International Capture the Flag&nbsp;Competition</a></li>
        <li><a href="http://bryceboe.com/2011/10/08/moving-images-in-3d-space-with-pyglet/">Moving Images in 3D Space with&nbsp;Pyglet</a></li>
        <li><a href="http://bryceboe.com/2011/06/05/defcon-19-quals-forensics-100-and-forensics-300-solution/">Defcon 19 Quals Forensics 100 and Forensics 300&nbsp;Solution</a></li>
        <li><a href="http://bryceboe.com/2010/12/09/ucsbs-international-capture-the-flag-competition-2010-challenge-6-fear-the-ear/"><span class="caps">UCSB</span>&#8217;s International Capture The Flag Competition 2010 Challenge 6: Fear The <span class="caps">EAR</span></a></li>
        <li><a href="http://bryceboe.com/2010/05/27/facebook-photograbber-updates/">Facebook Photograbber&nbsp;Updates</a></li>
    </ul>
</section>
    <hr />
    <section class="comments" id="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'bboe'; // required: replace example with your forum shortname
            var disqus_url = 'http://bryceboe.com/2011/01/28/the-python-multiprocessing-queue-and-large-objects/';
            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3 well well-sm" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
                  <ul class="list-group" id="social">
                    <li class="list-group-item">
                      <a href="https://github.com/bboe"><i class="fa fa-github fa-lg"></i></a>
                      <a href="https://github.com/bboe">github</a>
                    </li>
                    <li class="list-group-item">
                      <a href="http://stackoverflow.com/users/176978/bboe"><i class="fa fa-stack-overflow fa-lg"></i></a>
                      <a href="http://stackoverflow.com/users/176978/bboe">stack-overflow</a>
                    </li>
                    <li class="list-group-item">
                      <a href="http://www.linkedin.com/in/bbzbryce"><i class="fa fa-linkedin fa-lg"></i></a>
                      <a href="http://www.linkedin.com/in/bbzbryce">linkedin</a>
                    </li>
                    <li class="list-group-item">
                      <a href="https://plus.google.com/+BryceBoe?rel=author"><i class="fa fa-google-plus fa-lg"></i></a>
                      <a href="https://plus.google.com/+BryceBoe?rel=author">google+</a>
                    </li>
                    <li class="list-group-item">
                      <a href="https://twitter.com/bboe"><i class="fa fa-twitter fa-lg"></i></a>
                      <a href="https://twitter.com/bboe">twitter</a>
                    </li>
                  </ul>
                </li>

                <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
                    <ul class="list-group" id="recentposts">
                        <li class="list-group-item">
                            <a href="http://bryceboe.com/2014/03/27/daniel-boe-march-27-1988-february-28-2014/">
                                Daniel Boe: March 27, 1988 - February 28,&nbsp;2014
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://bryceboe.com/2014/01/25/hello-pelican-world/">
                                Hello Pelican&nbsp;World
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://bryceboe.com/2013/05/29/ph-d-proposal-announcement/">
                                Ph.D. Proposal&nbsp;Announcement
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://bryceboe.com/2013/05/12/mothers-day/">
                                Mother&#8217;s&nbsp;Day
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://bryceboe.com/2012/11/05/time-zones-in-python-and-datetime-representations/">
                                Time Zones in Python and Date/Time&nbsp;Representations
                            </a>
                        </li>
                    </ul>
                </li>


                <li class="list-group-item"><a href="http://bryceboe.com/tags/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                    <ul class="list-group" id="tags">
                    </ul>
                </li>    
    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://adamdoupe.com/" target="_blank">
                Adam Doupé
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://juliebifano.com/" target="_blank">
                Julie Bifano
            </a>
        </li>
      </ul>
    </li>

        </ul>
    </section>

</aside>        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2014 Bryce Boe
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://code.jquery.com/jquery.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://bryceboe.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://bryceboe.com/theme/js/respond.min.js"></script>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'bboe'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-510348-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();

    </script>
</body>
</html>