<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>Implementation of a Process-Based Job Management System in C - Bryce Boe</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    

    <!-- Open Graph tags -->
            <meta property="og:type" content="article"/>
            <meta property="og:title" content="Implementation of a Process-Based Job Management System in C"/>
            <meta property="og:url" content="https://bryceboe.com/2012/02/23/implementation-of-a-process-based-job-management-system-in-c/"/>
            <meta property="og:description" content="A few days ago I wrote about a few differences between using C and python to handle a process-based job management system. My discussion covered performance, development time, dependencies, and portability. I ended with the conclusion that despite C being vastly superior in performance, the relative difference in performance between …"/>

    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://bryceboe.com/theme/css/bootstrap.cerulean.min.css" type="text/css"/>
    <link href="https://bryceboe.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://bryceboe.com/theme/css/pygments/solarizedlight.css" rel="stylesheet">
        <link href="https://bryceboe.com/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="https://bryceboe.com/theme/css/style.css" type="text/css"/>

        <link href="https://bryceboe.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Bryce Boe ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://bryceboe.com/" class="navbar-brand">
Bryce Boe            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="https://bryceboe.com/archives/"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://bryceboe.com/2012/02/23/implementation-of-a-process-based-job-management-system-in-c/"
                       rel="bookmark"
                       title="Permalink to Implementation of a Process-Based Job Management System in C">
                        Implementation of a Process-Based Job Management System in&nbsp;C
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2012-02-23T23:03:00-08:00"> Thu 23 February 2012</time>
    </span>



<span class="label label-default">Tags</span>
	<a href="https://bryceboe.com/tag/c/">C</a>
        /
	<a href="https://bryceboe.com/tag/python/">python</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>A few days ago I wrote about <a href="/2012/02/20/process-based-job-management-in-c-and-python/" title="Process-Based Job Management in C and Python">a few differences between using C and python to
handle a process-based job management
system</a>. My discussion covered
performance, development time, dependencies, and portability. I ended with the
conclusion that despite C being vastly superior in performance, the relative
difference in performance between various job management systems is irrelevant
when considering the job processing time. Therefore, I recommended using python
for such a task due to faster development times, built-in support for
multiprocessing (no need for third-party libraries), and the portability one
immediately gains by using&nbsp;python.</p>
<p>In spite of my continuing recommendation to use python for such a task, I was
curious what a C solution might look like. Thus, I set out to write, and did
write, a simple process-based job management system in C that offers similar
functionality as python&#8217;s <a href="http://docs.python.org/library/multiprocessing.html#module-multiprocessing.pool">multiprocessing.Pool</a> class. Take note that
writing this system required more time than the equivalent python code would
have, however, the point is moot because python has the multiprocessing.Pool
class. Furthermore, whoever wants to use this system must manually include it
in their project, thus introducing a third-party dependency in their code.
Finally, this code will not compile in the typical Windows development
environment as it relies on <a href="http://en.wikipedia.org/wiki/POSIX"><span class="caps">POSIX</span>-based</a> system calls. Hence, for all the
reasons I previously mentioned, this C implementation is quite inferior to
python&#8217;s multiprocessing.Pool&nbsp;class.</p>
<p>The source that I reference throughout the remainder of this post can be <a href="https://gist.github.com/1894848">found
and downloaded in entirety</a>. On a <span class="caps">POSIX</span>-based machine the code can be
compiled via <code>gcc main.c job_management.c</code> and the test program can be run via
<code>./a.out</code>.</p>
<p>The system, or library, is contained in two files: <strong>job_management.h</strong> and
<strong>job_management.c</strong>. Anyone familiar with C or C++ development knows that
<strong>job_management.h</strong> is a header file which contains the structures and
function prototypes whereas <strong>job_management.c</strong> contains the implementation.
The entire library functionality is exposed through three functions:
<code>manager_init</code>, <code>manager_run_jobs</code>, and <code>manager_destruct</code>.</p>
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">manager_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">manager</span> <span class="o">*</span><span class="n">manager</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_workers</span><span class="p">,</span>
          <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">input_callback</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">),</span>
          <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">output_callback</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">),</span>
          <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">work_function</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span>
</pre></div>


<p>Aside from the pre-allocated <em>manager</em> structure that all the functions require
as their first parameter, the <code>manager_init</code> function requires four other
parameters: <em>num_workers</em>, <em>input_callback</em>, <em>output_callback</em>, and
<em>work_function</em>. The <em>num_workers</em> parameter specifies an upper bound on how
many worker processes to start. Each of the remaining parameters are function
pointers to functions that must each have a single char pointer parameter and
return no value. I will describe the purpose of these functions in the order
that they execute when considering only a single&nbsp;job.</p>
<p>The <em>input_callback</em> function is called by the master process, once per job,
in order to fetch the input for the job. The callback function stores the job
input in the provided buffer before returning. The <em>work_function</em> function is
the reason for the entire system as this function performs the job processing.
In this function, the provided buffer serves both as job input and job output.
On invocation, the buffer contains the result of a prior call to
<em>input_callback</em> which has been sent over a pipe between the master process
and worker process. On return, the buffer should contain the job output which
will then be sent back to the master process. The <em>output_callback</em> function
is called by the master process as each job is completed. In this case, the
buffer contains the output of a completed&nbsp;job.</p>
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">manager_run_jobs</span><span class="p">(</span><span class="k">struct</span> <span class="n">manager</span> <span class="o">*</span><span class="n">manager</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_jobs</span><span class="p">);</span>
</pre></div>


<p>Once the manager has been properly set up, a number of jobs can be started via
<code>manager_run_jobs</code> which takes one additional argument, <em>num_jobs</em>.
Intuitively this parameter represents the number of jobs to process. This
function contains the most complicated piece of the system as it is responsible
for forking the processes, setting up the pipes between the master and workers,
cleaning up the address space and file descriptor table for the workers, and
properly using I/O multiplexing in order to both send job input and receive job&nbsp;output.</p>
<p>One additional complication that the <code>manger_run_jobs</code> function has to handle
is <a href="/2010/08/26/python-multiprocessing-and-keyboardinterrupt/" title="Python Multiprocessing and KeyboardInterrupt">the issue</a> that started this entire series of blog posts; that is, the
want to gracefully exit the job management system when a keyboard interrupt
(<span class="caps">SIGINT</span>), occurs. Gracefully exiting means any jobs that are running at the
time of the keyboard interrupt will successfully complete prior to exiting,
thus giving the master process the chance to save partial results. This
function handles the desired behavior through the combination of a global
<a href="http://en.wikipedia.org/wiki/Volatile_variable">volatile</a> value that&#8217;s periodically checked within this function&#8217;s primary
loop, and a <span class="caps">SIGINT</span> handler function that updates the value. Worker processes
are unaffected by <span class="caps">SIGINT</span> as they are set to ignore&nbsp;it.</p>
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">manager_destruct</span><span class="p">(</span><span class="k">struct</span> <span class="n">manager</span> <span class="o">*</span><span class="n">manager</span><span class="p">);</span>
</pre></div>


<p>The last function, <code>manager_destruct</code>, conveniently frees the contents of the
<em>manager</em> structure. It is important to note that this function is also called
by each worker as part of its address space and file descriptor table clean up.
For this reason, the <code>manager_destruct</code> function handles the closing of some
<em><span class="caps">FILE</span></em> structures. Otherwise, this function is incredibly&nbsp;simple.</p>
<p>As previously mentioned, my job_management library is simple and thus is no
where near as flexible as python&#8217;s multiprocessing.Pool class. Furthermore, my
library has no support for data serialization as it relies on messages being no
larger than <em>MAX_MESSAGE</em> bytes in size, and has a limitation that the message
contents span only a single line. These restrictions were chosen for simplicity
and are, by no means, a limitation of C. However, again, I must point out that
object serialization is provided by default with python, and is built into the
multiprocess.Pool&nbsp;class.</p>
<p>Below is an example program that demonstrates using my process-based job
management system. Note that this code really isn&#8217;t that complicated,
especially when compared to <a href="/2012/02/14/python-multiprocessing-pool-and-keyboardinterrupt-revisited/" title="Python Multiprocessing Pool and KeyboardInterrupt Revisited">the python solution that gracefully handles the
keyboard interrupt</a>. Of course, the python solution is without dependencies
and much more portable.&nbsp;:)</p>
<p>Happy&nbsp;coding!</p>
<div class="gist">
    <script src='https://gist.github.com/1894848.js?file=main.c'></script>
    <noscript>
        <pre><code>#include <stdio.h>
#include <string.h>
#include "job_manager.h"

int job_num = 0;

/* This function is a worker function that does the work. On invocation, buffer
   contains a single line containing the input for the job. When complete,
   buffer should store the result of the job. The contents of the result must
   fit on a single line that ends with a single '\n'. */
void do_work(char *buffer) {
  int job = atoi(buffer);
  printf("%d started on job %d\n", getpid(), job);
  sleep(3 + getpid() % 3);
  snprintf(buffer, MAX_MESSAGE, "%d Success\n", job);
}

/* The message to send to the worker must be stored in the provided buffer of
   size MAX_MESSAGE. The contents must fit on a single line that ends with a
   single '\n' */
void prepare_job(char *buffer) {
  snprintf(buffer, MAX_MESSAGE, "%d\n", job_num++);
}

/* Process the single line result returned from the worker */
void process_result(char *buffer) {
  printf("%s", buffer);
}

int main(int argc, char *argv[]) {
  int i, num_jobs;
  struct manager manager;

  if (argc != 3) {
    printf("Usage: %s workers jobs\n", argv[0]);
    return 1;
  }
  num_jobs = atoi(argv[2]);

  manager_init(&manager, atoi(argv[1]), prepare_job, process_result, do_work);
  i = manager_run_jobs(&manager, num_jobs);
  manager_destruct(&manager);
  printf("%d of %d jobs completed\n", i, num_jobs);
  return 0;
}</code></pre>
    </noscript>
</div>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="https://bryceboe.com/2012/02/20/process-based-job-management-in-c-and-python/">Process-Based Job Management in C and&nbsp;Python</a></li>
        <li><a href="https://bryceboe.com/2010/09/14/properly-handling-the-keyboard-interrupt-exception-sigint-within-a-python-c-module/">Properly Handling the Keyboard Interrupt Exception (<span class="caps">SIGINT</span>) within a Python C&nbsp;Module</a></li>
        <li><a href="https://bryceboe.com/2007/09/22/telnet-like-client/">Telnet-like&nbsp;client</a></li>
        <li><a href="https://bryceboe.com/2007/09/02/signal-handling-and-select-in-c/">Signal Handling and Select in&nbsp;C</a></li>
        <li><a href="https://bryceboe.com/2014/01/25/hello-pelican-world/">Hello Pelican&nbsp;World</a></li>
    </ul>
</section>
    <hr />
    <section class="comments" id="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'bboe'; // required: replace example with your forum shortname
            var disqus_url = 'https://bryceboe.com/2012/02/23/implementation-of-a-process-based-job-management-system-in-c/';
            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3 well well-sm" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">
                <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
                  <ul class="list-group" id="social">
                    <li class="list-group-item">
                      <a href="https://github.com/bboe"><i class="fa fa-github fa-lg"></i></a>
                      <a href="https://github.com/bboe">github</a>
                    </li>
                    <li class="list-group-item">
                      <a href="http://stackoverflow.com/users/176978/bboe"><i class="fa fa-stack-overflow fa-lg"></i></a>
                      <a href="http://stackoverflow.com/users/176978/bboe">stack-overflow</a>
                    </li>
                    <li class="list-group-item">
                      <a href="http://www.linkedin.com/in/bbzbryce"><i class="fa fa-linkedin fa-lg"></i></a>
                      <a href="http://www.linkedin.com/in/bbzbryce">linkedin</a>
                    </li>
                    <li class="list-group-item">
                      <a href="https://plus.google.com/+BryceBoe?rel=author"><i class="fa fa-google-plus fa-lg"></i></a>
                      <a href="https://plus.google.com/+BryceBoe?rel=author">google+</a>
                    </li>
                    <li class="list-group-item">
                      <a href="https://twitter.com/bboe"><i class="fa fa-twitter fa-lg"></i></a>
                      <a href="https://twitter.com/bboe">twitter</a>
                    </li>
                  </ul>
                </li>

                <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
                    <ul class="list-group" id="recentposts">
                        <li class="list-group-item">
                            <a href="https://bryceboe.com/2014/03/27/daniel-boe-march-27-1988-february-28-2014/">
                                Daniel Boe: March 27, 1988 - February 28,&nbsp;2014
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="https://bryceboe.com/2014/01/25/hello-pelican-world/">
                                Hello Pelican&nbsp;World
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="https://bryceboe.com/2013/05/29/ph-d-proposal-announcement/">
                                Ph.D. Proposal&nbsp;Announcement
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="https://bryceboe.com/2013/05/12/mothers-day/">
                                Mother&#8217;s&nbsp;Day
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="https://bryceboe.com/2012/11/05/time-zones-in-python-and-datetime-representations/">
                                Time Zones in Python and Date/Time&nbsp;Representations
                            </a>
                        </li>
                    </ul>
                </li>


                <li class="list-group-item"><a href="https://bryceboe.com/tags/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                    <ul class="list-group" id="tags">
                    </ul>
                </li>    
    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://adamdoupe.com/" target="_blank">
                Adam Doupé
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://juliebifano.com/" target="_blank">
                Julie Bifano
            </a>
        </li>
      </ul>
    </li>

        </ul>
    </section>

</aside>        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2014 Bryce Boe
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="//code.jquery.com/jquery.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://bryceboe.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://bryceboe.com/theme/js/respond.min.js"></script>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'bboe'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-510348-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();

    </script>
</body>
</html>